! INPUT: REAL (single precision) datacube (n,n,n) where n is the number of grid per side
! n12 = n/2-1 for n is even ; IF n is odd, n12 = (n-1)/2 
! OUTPUT: D2power = dimensionless power spectrum k^3 P(k)/(2 pi^2) Vs unitless k = (1:n12). 
! physical k = (unitless k) * 2 pi/(boxsize) 
! In ranger, first run in command: module swap pgi intel; module load fftw3 -- to load mvapich and ifort and fftw3 
! compile like this: ifort -O3 -xW -openmp -I$TACC_FFTW3_INC nrtype.f90 powers.f90 mainbody.f90  -L$TACC_FFTW3_LIB -lfftw3_threads -lfftw3 -lm -o powers.x
! set OMP command in qsub command in Ranger


program mainbody
  use nrtype
  implicit none
  
  include 'fftw3.f'
  
  ! give n 
  ! if n is odd, change n12 here, and n121 in the subroutine compute_fftw
  integer, parameter :: n = 256, n12 = n/2-1
  real(sp), parameter :: boxsize = 200  ! in Mpc/h
  real(sp), parameter :: kstep = 2.* PI / boxsize
  
  integer :: ierr, num_procs, OMP_GET_NUM_PROCS, kint
  character(len=60) :: datafile, datafile1, datafile2
  real(sp),dimension(n,n,n) :: cube, cube1, cube2
  real(sp),dimension(1:n12) :: D2power 
  
  call dfftw_init_threads(ierr)
  if (ierr .eq. 0) stop 'Fatal error: multithread FFTW initiated incorrectly'
  num_procs = OMP_GET_NUM_PROCS()
  print *,'Number OMP PROCS = ', num_procs
  call dfftw_plan_with_nthreads(num_procs)

  ! give datafile here 
  !datafile1 = '../50p_highang_parallel_field'
  !datafile2 = '../50p_lowang_parallel_field'
  datafile = '../50p_lowang_parallel_field'

  ! auto power 
  call read_density_cube2(n,datafile,cube)
  call pipeline_w_spherical_averaging(n,n12,cube,D2power) 
  
  ! cross power of data 1 and data 2
  !call read_density_cube2(n,datafile1,cube1)
  !call read_density_cube2(n,datafile2,cube2)
  !call pipeline_xpower_w_spherical_averaging(n,n12,cube1,cube2, D2power)
  
  ! then do whatever on D2power yourself
  open (20,file = 'lowang.dat')
    write (20,'(a)')'k[unitless]    k[h/Mpc]    D^2(k)'
    do kint = 1,n12
      write (20,'(I6,20(E15.5))') kint, kstep*real(kint), D2power(kint)
    end do
  close (20)
  
  stop
end program mainbody
